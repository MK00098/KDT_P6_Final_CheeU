# CheeU RAG Pipeline 아키텍처

## 🏗️ 시스템 구조

```
┌─────────────────────────────────────────────────────┐
│                 Streamlit UI                        │
│        사용자 입력 | 프로필 정보 | 결과 표시          │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│                   API Layer                         │
│           quick_healing_message()                   │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│                Pipeline Layer                       │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │ 스트레스분류  │→ │  프로필생성   │→│  메시지생성 │ │
│  └──────────────┘  └──────────────┘  └────────────┘ │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│                  Chatbot Engine                     │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │ VectorDB검색  │→│ 프롬프트생성  │→│  LLM 호출  │ │
│  └──────────────┘  └──────────────┘  └────────────┘ │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│               External Services                     │
│  ┌──────────────┐              ┌──────────────────┐ │
│  │   ChromaDB   │              │   OpenAI API     │ │
│  │  (임베딩DB)  │              │   (GPT-4o)       │ │
│  └──────────────┘              └──────────────────┘ │
└─────────────────────────────────────────────────────┘
```

## 🔄 데이터 흐름

### 1. 입력 단계
```
사용자 정보 수집
├── 기본정보: 닉네임, 나이, 성별, 직업
├── 스트레스 지표: 우울, 불안, 직무스트레스
├── 설문키워드: 증상 키워드들
└── 사용자 입력: 고민 내용
```

### 2. 스트레스 유형 분류
```python
Depression × Anxiety × Work_Stress = 8가지 유형
```

| D | A | W | 유형 | 캐릭터 | 치료법 |
|---|---|---|------|--------|---------|
| X | X | X | XXX | 평온형 🦥 | MBSR |
| O | X | X | OXX | 우울형 🐻 | PPT+MBSR |
| X | O | X | XOX | 불안형 🐰 | ACT+MBSR |
| X | X | O | XXO | 직무스트레스형 🦔 | ACT+CBT |
| O | O | X | OOX | 우울+불안형 🦌 | PPT+ACT+CBT |
| O | X | O | OXO | 우울+직무형 🦫 | PPT+ACT |
| X | O | O | XOO | 불안+직무형 🐿️ | ACT+CBT |
| O | O | O | OOO | 위기형 🦊 | PPT+ACT+DBT |

### 3. 검색 전략 (2단계 필터링)

#### 1차 필터링: 치료법 범위 제한
```python
stress_type → therapy_methods → 관련 논문만
```

#### 2차 필터링: 개인화 검색
```python
main_query = user_input
sub_queries = [
    demographic_info,  # 연령+성별
    occupation_keywords,  # 직군 키워드
    survey_keywords  # 설문 키워드
]
```

### 4. LLM 프롬프트 구조

```
[시스템 프롬프트]
├── 사용자 프로필 컨텍스트
├── VectorDB 검색 결과 (관련 논문)
├── 스트레스 유형별 치료법 가이드
└── 출력 형식 지정
    ├── 💊 캡슐 색상 (치료법별)
    ├── 🎯 핵심 메시지 (공감+희망)
    ├── 🔧 실천 방법 (3가지)
    └── ⭐ 격려 문구
```

## 🎯 핵심 특징

### RAG (Retrieval-Augmented Generation)
- **Retrieval**: VectorDB에서 관련 논문 검색
- **Augmentation**: 검색 결과를 프롬프트에 통합
- **Generation**: GPT-4o로 개인화 메시지 생성

### 개인화 전략
1. **스트레스 유형**: 8가지 분류
2. **치료법 매핑**: 유형별 최적 치료법
3. **인구통계**: 연령대, 성별
4. **직군 특화**: 24개 NCS 분류
5. **설문 키워드**: 개인 증상 반영

### 성능 최적화
- 2단계 필터링으로 검색 범위 축소
- 우선순위 가중치 검색
- 구조화된 프롬프트
- 재시도 로직 (max_retries=3)

## 🔧 기술 스택

| 계층 | 기술 | 역할 |
|------|------|------|
| Frontend | Streamlit | Web UI |
| Backend | Python 3.8+ | Business Logic |
| LLM | OpenAI GPT-4o | Text Generation |
| VectorDB | ChromaDB | Document Storage |
| Embedding | SentenceTransformers | Text Vectorization |
| Framework | LangChain | Pipeline Orchestration |

## 📊 모듈별 역할

### models.py
- 데이터 모델 정의
- 스트레스 유형 Enum
- 치료법 정의
- 페르소나 키워드

### pipeline.py
- 메인 오케스트레이션
- 스트레스 유형 결정
- 프로필 생성
- 에러 핸들링

### chatbot.py
- LangChain 통합
- VectorDB 검색
- 프롬프트 생성
- LLM 호출

### vectordb.py
- ChromaDB 관리
- 임베딩 생성
- 유사도 검색
- 신뢰도 계산

### api.py
- 간편 API 함수
- 싱글톤 파이프라인
- 파라미터 검증
