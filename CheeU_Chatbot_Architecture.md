# CheeU RAG+LLM Pipeline 아키텍처

## 🏗️ 시스템 구조

```
┌─────────────────────────────────────────────────────┐
│                 Streamlit UI                        │
│        사용자 입력 | 프로필 정보 | 결과 표시          │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│                   API Layer                         │
│           quick_healing_message()                   │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│                Pipeline Layer                       │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │ 스트레스분류  │→ │  프로필생성   │→│  메시지생성 │ │
│  └──────────────┘  └──────────────┘  └────────────┘ │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│                  Chatbot Engine                     │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │ VectorDB검색  │→│ 프롬프트생성  │→│  LLM 호출  │ │
│  └──────────────┘  └──────────────┘  └────────────┘ │
└─────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────┐
│               External Services                     │
│  ┌──────────────┐              ┌──────────────────┐ │
│  │   ChromaDB   │              │   OpenAI API     │ │
│  │  (임베딩DB)  │              │   (GPT-4o)       │ │
│  └──────────────┘              └──────────────────┘ │
└─────────────────────────────────────────────────────┘
```

## 🔄 데이터 흐름

### [치유 챗봇 프로세스]
```
챗봇 사용자 입력 → A.치유 캡슐 B.치유 비타민 중 선택 → 맞춤 생성
```

### [[A.치유 캡슐 생성 프로세스]]
```
챗봇 사용자 입력 → 사용자DB 검색 통해 프로필 분석 → VectorDB 검색 →
프롬프트 생성 → LLM에게 프롬프트 전달 → 답변 회신 → 챗봇 화면 출력
```

### 1. 사용자 프로필 분석
```
사용자 정보 수집
├── 기본정보: 닉네임, 나이, 성별, 직업
├── 스트레스 지표: PHQ-9, GAD-7, KOSS (0/1 레이블)
├── 설문키워드: 증상 키워드들
└── 사용자 입력: 고민 내용
```

### 2. 스트레스 유형 분류
```python
Depression × Anxiety × Work_Stress = 8가지 유형
```

| D | A | W | 유형 | 캐릭터 | 치료법 |
|---|---|---|------|--------|---------|
| X | X | X | XXX | 평온형 🦥 | MBSR |
| O | X | X | OXX | 우울형 🐭 | PPT+MBSR |
| X | O | X | XOX | 불안형 🐻 | ACT+MBSR |
| X | X | O | XXO | 직무스트레스형 🐹 | ACT+CBT |
| O | O | X | OOX | 우울+불안형 🦉 | PPT+ACT+CBT |
| O | X | O | OXO | 우울+직무형 🐿️ | PPT+ACT |
| X | O | O | XOO | 불안+직무형 🦝 | ACT+CBT |
| O | O | O | OOO | 위기형 🦊 | PPT+ACT+DBT |

### 3. [[[VectorDB 검색 프로세스]]] (3단계 필터링)

#### 1차 필터링: 치료법 범위 제한
```python
stress_type → therapy_methods → 관련 논문만
```

#### 2차 필터링: 사용자 입력 키워드
```python
main_query = user_input  # 챗봇 프롬프트
```

#### 3차 필터링: 개인화 검색
```python
sub_queries = [
    demographic_info,  # 연령+성별
    occupation_keywords,  # 직군 키워드
    survey_keywords  # 설문 키워드 (2,3점 항목)
]
```

### 4. [[[A.캡슐 프롬프트 형식]]]

```
"""CheeU 톡톡이 {nickname}님을 위한 맞춤 CheeU 캡슐을 준비했습니다.

💊 사용자 프로필 분석
- 1.스트레스 유형: {stress_type}
- 2.챗봇 입력 값: {user_input}
- 3.{age}세 {gender} {occupation}
- 4.설문지 기반 특징: {survey_features}

📚 전문 연구 자료 분석
{vector_context}

🎯 CheeU 캡슐 생성 지침
위 정보를 바탕으로 {nickname}님에게 적합한 개인화된 CheeU 캡슐을 생성해주세요.

💝 CheeU 캡슐 구성 요소:
1. 💊 캡슐 색상: 적용되는 치료기법에 따른 색상 지정
   - 인지행동치료(CBT): 파란색 💙
   - 마음챙김(MBSR): 초록색 💚
   - 긍정심리치료(PPT): 노란색 💛
   - 수용전념치료(ACT): 주황색 🧡
   - 변증법적행동치료(DBT): 보라색 💜

2. 🎯 핵심 메시지: {nickname}님의 상황에 구체적으로 공감하며 희망을 주는 메시지

3. 🔧 실천 방법: 연구 자료 기반의 구체적이고 실행 가능한 방법 (3가지)

4. ⭐ 격려 문구: 따뜻하고 희망적인 마무리
"""
```

### [[B.치유 비타민 생성 프로세스]]
```
챗봇 사용자 입력 → 사용자DB 검색 통해 프로필 분석 →
프롬프트 생성 → LLM에게 프롬프트 전달 → 답변 회신 → 챗봇 화면 출력
```

#### [[[B.비타민 프롬프트 형식]]]
```
💊 사용자 프로필 분석
- 1.스트레스 유형: {stress_type}
- 2.챗봇 입력 값: {user_input}
- 3.{age}세 {gender} {occupation}
- 4.설문지 기반 특징: {survey_features}

🎯 CheeU 비타민 생성 지침
위 정보를 바탕으로 {nickname}님에게 적합한 개인화된 CheeU 비타민을 생성해주세요.

💝 CheeU 비타민 구성 요소:
일상에서 적용가능한 소소하고 재치있는 일탈 요소를 즐겁게 추천해주세요.
예시 :
"오늘은 평소보다 한 정거장 지나쳐서 내려봐요! 매일 똑같이 갈 필요 없잖아요?"
"에잇 일탈이다! 롯데월드 가서 아이스크림과 함께 퍼레이드 지켜보기!"
"오늘 운이 좋은데요~? 평소에 하고 싶던 소소한 일탈 하나 해볼까요?"
```

## 🎯 핵심 특징

### RAG (Retrieval-Augmented Generation)
- **Retrieval**: VectorDB에서 관련 논문 검색
- **Augmentation**: 검색 결과를 프롬프트에 통합
- **Generation**: GPT-5-nano로 개인화 메시지 생성

### 개인화 전략
1. **스트레스 유형**: 8가지 분류
2. **치료법 매핑**: 유형별 최적 치료법
3. **인구통계**: 연령대, 성별
4. **직군 특화**: 24개 NCS 분류
5. **설문 키워드**: 개인 증상 반영

### 성능 최적화
- 3단계 필터링으로 검색 범위 축소
- 우선순위 가중치 검색
- 구조화된 프롬프트
- 재시도 로직 (max_retries=3)

## 🔧 기술 스택

| 계층 | 기술 | 역할 |
|------|------|------|
| Frontend | Streamlit | Web UI |
| Backend | Python 3.8+ | Business Logic |
| LLM | OpenAI GPT-4o | Text Generation |
| VectorDB | ChromaDB | Document Storage |
| Embedding | SentenceTransformers | Text Vectorization |
| Framework | LangChain | Pipeline Orchestration |

## 📊 모듈별 역할

### models.py
- 데이터 모델 정의
- 스트레스 유형 Enum
- 치료법 정의
- 페르소나 키워드

### pipeline.py
- 메인 오케스트레이션
- 스트레스 유형 결정
- 프로필 생성
- 에러 핸들링

### chatbot.py
- LangChain 통합
- VectorDB 검색
- 프롬프트 생성
- LLM 호출

### vectordb.py
- ChromaDB 관리
- 임베딩 생성
- 유사도 검색
- 신뢰도 계산

### api.py
- 간편 API 함수
- 싱글톤 파이프라인
- 파라미터 검증